<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>42 - Gestionale Calendario</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='42_Logo.svg.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='42_Logo.svg.png') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-dark-42">
    <nav class="navbar navbar-expand-lg navbar-dark bg-42-black shadow-lg">
        <div class="container-fluid px-4">
            <a class="navbar-brand text-42-cyan fw-bold d-flex align-items-center" href="{{ url_for('home') }}">
                <span class="fs-2 me-2">42</span>
                <span class="d-none d-md-inline">Baywatcher</span>
            </a>
            <button aria-label="menu" class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if session.user %}
                    {% if request.endpoint != 'home' %}
                    <li class="nav-item me-3">
                        <a class="btn btn-outline-success btn-sm px-3" href="{{ url_for('home') }}">
                            üìÖ Calendario
                        </a>
                    </li>
                    {% endif %}
                    {% if session.user.is_admin %}
                    <li class="nav-item me-3">
                        <a class="btn btn-outline-success btn-sm px-3" href="{{ url_for('admin_panel') }}">
                            üîß Admin Panel
                        </a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="btn btn-outline-success btn-sm px-3" href="{{ url_for('participants_summary') }}">
                            üë• Riepilogo Partecipanti
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center text-42-cyan px-2" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% if session.user.image_url %}
                            <img src="{{ session.user.image_url }}" alt="Avatar" class="rounded-circle me-2 border border-2 border-success" style="width: 35px; height: 35px;">
                            {% endif %}
                            <span class="fw-semibold">{{ session.user.login }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" aria-labelledby="navbarDropdown">
                            <li class="px-3 py-2 border-bottom">
                                <small class="text-muted">Benvenuto!</small>
                                <div class="fw-bold text-42-cyan">{{ session.user.display_name or session.user.login }}</div>
                                <div class="mt-2 d-flex align-items-center">
                                    <span class="badge bg-warning text-dark">
                                        ‚Ç≥ {{ session.user.wallet }}
                                    </span>
                                </div>
                            </li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('user_profile') }}">
                                <span class="me-2">üë§</span> Il Mio Profilo
                            </a></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('logout') }}">
                                <span class="me-2">üö™</span> Logout
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Flash Messages -->
    <div class="container-fluid mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {% if category == 'danger' %}
                            <strong>‚ö†Ô∏è Attenzione!</strong>
                        {% elif category == 'success' %}
                            <strong>‚úì Successo!</strong>
                        {% elif category == 'warning' %}
                            <strong>‚ö†Ô∏è Avviso!</strong>
                        {% elif category == 'info' %}
                            <strong>‚ÑπÔ∏è Info:</strong>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Socket.IO Client for real-time updates (LOCAL) -->
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom Time Picker with Validation -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza i time picker
            const timePickers = document.querySelectorAll('.time-picker');
            
            timePickers.forEach(function(input) {
                // Rimuovi readonly per permettere scrittura manuale
                input.removeAttribute('readonly');
                
                // Variabile per tracciare l'ultimo valore
                let lastValue = '';
                
                // Gestione backspace sui due punti
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace') {
                        const cursorPos = e.target.selectionStart;
                        const value = e.target.value;
                        
                        // Se il cursore √® subito dopo i :, rimuovi anche la cifra prima
                        if (cursorPos > 0 && value[cursorPos - 1] === ':') {
                            e.preventDefault();
                            e.target.value = value.substring(0, cursorPos - 1) + value.substring(cursorPos);
                            e.target.selectionStart = e.target.selectionEnd = cursorPos - 1;
                        }
                    }
                });
                
                // Validazione input manuale con formattazione in tempo reale
                input.addEventListener('input', function(e) {
                    let value = e.target.value;
                    const cursorPos = e.target.selectionStart;
                    
                    // Rimuovi tutto tranne numeri e :
                    value = value.replace(/[^0-9:]/g, '');
                    
                    // Se l'utente sta cancellando, lascia il controllo
                    if (value.length < lastValue.length) {
                        lastValue = value;
                        e.target.value = value;
                        return;
                    }
                    
                    // Rimuovi : multipli
                    const parts = value.split(':');
                    if (parts.length > 2) {
                        value = parts[0] + ':' + parts.slice(1).join('');
                    }
                    
                    // Formattazione intelligente
                    if (!value.includes(':')) {
                        // Solo numeri, nessun :
                        if (value.length === 1) {
                            // Prima cifra: 0-2 ok, 3-9 aggiungi 0 davanti e :
                            const firstDigit = parseInt(value);
                            if (firstDigit >= 3) {
                                value = '0' + value + ':';
                            }
                        } else if (value.length === 2) {
                            // Due cifre: aggiungi : automaticamente
                            const hours = parseInt(value);
                            if (hours > 23) {
                                // Se supera 23, prendi solo la seconda cifra
                                value = '0' + value.charAt(1) + ':';
                            } else {
                                value = value + ':';
                            }
                        } else if (value.length > 2) {
                            // Pi√π di 2 cifre senza :, inserisci : dopo le prime 2
                            value = value.substring(0, 2) + ':' + value.substring(2);
                        }
                    } else {
                        // Contiene gi√† :
                        const [hours, minutes] = value.split(':');
                        
                        // Limita ore a 2 cifre e valida
                        let limitedHours = hours.substring(0, 2);
                        if (limitedHours.length === 2) {
                            const h = parseInt(limitedHours);
                            if (h > 23) {
                                limitedHours = '23';
                            }
                        }
                        
                        // Limita minuti a 2 cifre e valida
                        let limitedMinutes = minutes ? minutes.substring(0, 2) : '';
                        if (limitedMinutes.length === 2) {
                            const m = parseInt(limitedMinutes);
                            if (m > 59) {
                                limitedMinutes = '59';
                            }
                        }
                        
                        value = limitedHours + ':' + limitedMinutes;
                    }
                    
                    // Limita lunghezza massima a 5 (HH:MM)
                    if (value.length > 5) {
                        value = value.substring(0, 5);
                    }
                    
                    lastValue = value;
                    e.target.value = value;
                });
                
                // Validazione al blur
                input.addEventListener('blur', function(e) {
                    let value = e.target.value.trim();
                    
                    // Se il valore √® vuoto, non fare nulla
                    if (!value) return;
                    
                    // Se √® solo un numero (es: "9"), aggiungi :00
                    if (/^\d{1,2}$/.test(value)) {
                        const h = parseInt(value);
                        const validH = Math.min(23, Math.max(0, h));
                        e.target.value = `${String(validH).padStart(2, '0')}:00`;
                        return;
                    }
                    
                    // Se contiene i due punti
                    if (value.includes(':')) {
                        const [hours, minutes] = value.split(':');
                        const h = parseInt(hours) || 0;
                        const m = parseInt(minutes) || 0;
                        
                        // Valida e correggi
                        const validH = Math.min(23, Math.max(0, h));
                        const validM = Math.min(59, Math.max(0, m));
                        
                        e.target.value = `${String(validH).padStart(2, '0')}:${String(validM).padStart(2, '0')}`;
                        
                        // Valida start_time < end_time
                        validateTimeRange();
                    }
                });
            });
            
            // Funzione per validare che start_time < end_time
            function validateTimeRange() {
                const startInput = document.getElementById('start_time');
                const endInput = document.getElementById('end_time');
                
                if (!startInput || !endInput) return;
                
                const startValue = startInput.value;
                const endValue = endInput.value;
                
                // Controlla solo se entrambi i campi sono compilati
                if (startValue && endValue && startValue.includes(':') && endValue.includes(':')) {
                    const [startH, startM] = startValue.split(':').map(Number);
                    const [endH, endM] = endValue.split(':').map(Number);
                    
                    const startMinutes = startH * 60 + startM;
                    const endMinutes = endH * 60 + endM;
                    
                    // Rimuovi eventuali messaggi di errore precedenti
                    const existingError = startInput.parentElement.querySelector('.time-validation-error');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // Se start >= end, mostra errore
                    if (startMinutes >= endMinutes) {
                        startInput.classList.add('is-invalid');
                        endInput.classList.add('is-invalid');
                        
                        // Crea messaggio di errore
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'time-validation-error text-danger small mt-1';
                        errorMsg.innerHTML = '‚ö†Ô∏è L\'orario di inizio deve essere minore dell\'orario di fine';
                        startInput.parentElement.appendChild(errorMsg);
                        
                        return false;
                    } else {
                        // Valido - rimuovi classe di errore
                        startInput.classList.remove('is-invalid');
                        endInput.classList.remove('is-invalid');
                        return true;
                    }
                }
                return true;
            }
            
            // Validazione anche al submit del form
            const addEventForm = document.querySelector('form[action*="add_event"]');
            if (addEventForm) {
                addEventForm.addEventListener('submit', function(e) {
                    if (!validateTimeRange()) {
                        e.preventDefault();
                        
                        // Scroll al messaggio di errore
                        const errorMsg = document.querySelector('.time-validation-error');
                        if (errorMsg) {
                            errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // Mostra alert
                        alert('‚ö†Ô∏è Attenzione: L\'orario di inizio deve essere minore dell\'orario di fine!');
                    }
                });
            }
        });
    </script>
    
    <!-- Push Notifications Script (only for logged in users) -->
    {% if session.user %}
    <script src="{{ url_for('static', filename='push-notifications.js') }}"></script>
    {% endif %}
</body>
</html>
